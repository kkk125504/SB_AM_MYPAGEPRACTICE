 ### Rq 객체 생성을 스프링이 하도록(빈으로 등록)

**1\) Rq 객체**

```java
    @Component
    @Scope(value = "request", proxyMode = ScopedProxyMode.TARGET_CLASS)
        public class Rq {
            @Getter
            private boolean isLogined;
            @Getter
                  ~~~ 생략 ~~~~
        public Rq(HttpServletRequest req, HttpServletResponse resp, MemberService memberService) {
                  ~~~ 생략 ~~~~	
            this.loginedMemberId = loginedMemberId;
            this.loginedMember = loginedMember;
            this.req.setAttribute("rq", this);
        }
```

- Rq객체를 빈으로 등록하기위해 @Component 어노테이션을 사용
- @ComponentScan을 통해 @Component어노테이션이 붙은 클래스를 빈으로 등록
- 기존에는 ```BeforeActionInterceptor``` 인터셉터에서 ```new연산자```를 통해 ```Rq객체를 생성하여 ``` request.setAttribute("rq", rq) 하여 Rq객체를 사용 하였다.
- 하지만 빈으로 등록했기 때문에 @Autowired를 통해 ```의존성 주입```이 가능하다.
- ```this.req.setAttribute("rq", this)``` Rq객체 자신을 ```HttpServletRequest객체```에 setAttribute를 하여 사용

**2\) Rq객체 주입**

```java
    @Component
    public class NeedLoginInterceptor implements HandlerInterceptor {
        @Autowired
        private Rq rq;    
```

```java
    @Controller
    public class UsrArticleController {
        @Autowired
        private Rq rq;
```

- 빈으로 등록된 rq객체를 주입하여 사용



**3\) Rq객체 빈등록시 문제 발생에 대한 해결**

만약 ```usr/article/write``` 요청이 오면

- NeedLoginInterceptor(인터셉터)에서 ```rq객체```를 주입받는다.

- 이때 ```생성과 함께 주입```이 되고 Rq객체는 생성시  Rq객체 자신을```HttpServletRequest객체에 setAttribute```한다.
- 그리고 컨트롤러로 연결이되고 컨트롤러에서도 ```rq객체를 주입```받는데 이때 rq객체는 빈으로 등록되면 ```싱글톤패턴```이므로 

- 두 레퍼런스가 하나의 ```동일한 인스턴스```를 사용한다.  

- usr/article/write.jsp파일로 이동 ```HttpServletRequest객체에 setAttribute```했기때문에  ```jsp```에서 rq객체를 사용가능



하지만 ```usr/home/main```  요청이 오면

- NeedLoginInterceptor(인터셉터)에서 ```rq객체```를 주입받고 ```HttpServletRequest객체에 setAttribute```한다.

- ```NeedLoginInterceptor(인터셉터)```는 아래코드에서 추가한 uri패턴에서만 인터셉터가 적용되는데

- ```java
  	registry.addInterceptor(needLoginInterceptor).addPathPatterns("/usr/article/write")
  				.addPathPatterns("/usr/article/doWrite").addPathPatterns("/usr/article/modify")
  				.addPathPatterns("/usr/article/doModify").addPathPatterns("/usr/article/doDelete");}
  ```

- rq객체는 ```usr/home/main``` 로 요청시 ```NeedLoginInterceptor```가 적용되지않아 rq객체는 생성되지않는다.

- rq객체가 생성되지 않는다면 ```jsp```에서 rq객체를 사용할수 없다.

- 이를 해결하기 위해 아래코드에서 ```BeforeActionInterceptor``` ( ```.addPathPatterns("/**")``` )에서 rq객체를 주입받고 있다. 

- ```java
      @Component
      public class BeforeActionInterceptor implements HandlerInterceptor {
          @Autowired
          private Rq rq;
          @Override
          public boolean preHandle(HttpServletRequest req, HttpServletResponse resp, Object handler) throws Exception {
                  rq.initOnBeforeActionInterceptor();
              return HandlerInterceptor.super.preHandle(req, resp, handler);
          }
  ```

- 하지만 @Autowired를 했음에도 ```rq객체가 사용되지 않는다면``` 어플리케이션 실행시 rq객체는 ```주입받지 않는것```으로 보인다.

- rq.initOnBeforeActionInterceptor()메소드를 실행함으로써 rq객체를 주입받는것으로 보인다.
